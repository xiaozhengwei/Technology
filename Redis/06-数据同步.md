# 数据同步



 ## Redis 具有高可靠性

- 一是数据尽量少丢失

```
AOF 和 RDB 
```

- 二是服务尽量少中断。

```
增加副本冗余量，将一份数据同时保存在多个实例上。即使有一个实例出现了故障，需要过一段时间才能恢复，其他实例也可以对外提供服务，不会影响业务使用。
```



## 主从库模式

Redis 提供了主从库模式，以保证数据副本的一致，主从库之间采用的是读写分离的方式。

- 读操作：主库、从库都可以接收；

- 写操作：首先到主库执行，然后，主库将写操作同步给从库。

![img](.\images\06-01)



### 主从库间如何进行第一次同步

启动多个 Redis 实例的时候，它们相互之间就可以通过 **replicaof**（Redis 5.0 之前使用 slaveof）命令形成主库和从库的关系，之后会按照三个阶段完成数据的第一次同步。

```shell
replicaof 172.16.19.3 6379
```

![img](.\images\06-02)

- 第一阶段是主从库间建立连接、协商同步的过程，主要是为全量复制做准备。在这一步，从库和主库建立起连接，并告诉主库即将进行同步，主库确认回复后，主从库间就可以开始同步了。

  ```
  从库给主库发送 psync 命令，表示要进行数据同步，主库根据这个命令的参数来启动复制。
  psync 命令包含了主库的 runID 和复制进度 offset 两个参数。
  runID，是每个 Redis 实例启动时都会自动生成的一个随机 ID，用来唯一标记这个实例。
  当从库和主库第一次复制时，因为不知道主库的 runID，所以将 runID 设为“？”。
  offset，此时设为 -1，表示第一次复制。
  主库收到 psync 命令后，会用 FULLRESYNC 响应命令带上两个参数：主库 runID 和主库目前的复制进度 offset，返回给从库。从库收到响应后，会记录下这两个参数。
  这里有个地方需要注意，FULLRESYNC 响应表示第一次复制采用的全量复制，也就是说，主库会把当前所有的数据都复制给从库。
  ```

- 第二阶段，主库将所有数据同步给从库。从库收到数据后，在本地完成数据加载。这个过程依赖于内存快照生成的 RDB 文件。

- 第三个阶段，主库会把第二阶段执行过程中新收到的写命令，再发送给从库。具体的操作是，当主库完成 RDB 文件发送后，就会把此时 replication buffer 中的修改操作发给从库，从库再重新执行这些操作。这样一来，主从库就实现同步了。





## 缓冲空间

缓冲空间的计算公式是：缓冲空间大小 = 主库写入命令速度 * 操作大小 - 主从库间网络传输命令速度 * 操作大小。在实际应用中，考虑到可能存在一些突发的请求压力，我们通常需要把这个缓冲空间扩大一倍，即 repl_backlog_size = 缓冲空间大小 * 2，这也就是 repl_backlog_size 的最终值。

